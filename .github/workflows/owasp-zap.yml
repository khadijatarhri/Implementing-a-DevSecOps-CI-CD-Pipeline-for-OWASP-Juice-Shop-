name: "DAST - OWASP ZAP Scan (Docker)"

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  zap_scan:
    name: OWASP ZAP Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Pull Juice Shop Docker Image
      run: |
        docker pull bkimminich/juice-shop:latest
        
    - name: Start Juice Shop Container
      run: |
        docker run -d -p 3000:3000 --name juice-shop bkimminich/juice-shop:latest
        echo "Waiting for container to start..."
        sleep 30
        
    - name: Verify application is running
      run: |
        timeout 60 bash -c 'until curl -f http://localhost:3000; do sleep 5; done'
        curl -I http://localhost:3000
        
    - name: Run OWASP ZAP Baseline Scan
      uses: zaproxy/action-baseline@v0.12.0
      with:
        target: 'http://localhost:3000'
        cmd_options: '-a -j'
      continue-on-error: true
        
    - name: Stop Juice Shop Container
      if: always()
      run: |
        docker stop juice-shop || true
        docker rm juice-shop || true
        
    - name: Upload ZAP Reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: zap-reports-${{ github.run_id }}
        path: |
          report_html.html
          report_md.md
          report_json.json
        retention-days: 30
